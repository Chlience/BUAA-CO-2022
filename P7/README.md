# P7 支持异常的流水线 CPU

* CP0 寄存器与流水线整合
* 流水线异常生成
* 流水线异常处理指令支持
* 流水线异常处理方式

当遇到一个异常时，我们需要做什么？

* 将异常信息提交到 CP0
* 保证异常指令及其之后的指令不再执行
* 控制权转交给异常处理程序

在流水线中这样实现：

* 清空 D, E, M 级流水线寄存器
* 将 NPC 设置为异常处理程序入口

我们需要处理异常处理程序的 `ERET` 指令：

* `ERET` 指令进入流水线，后续指令设置为 `NOP`
* `ERET` 指令在 M 级跳转，保证后续指令已经执行完毕，防止再次触发异常

注意到需要处理延迟槽指令

当异常行为发生时，受害指令可能有两种情况：

* 一条普通的平平无奇的指令
* 一条由于 Stall 产生的 `NOP`

前者的处理情况较为简单，EPC 正常设置即可

而我们注意到第二种情况下真正的受害指令应该是由于 Stall **产生** `NOP` 的指令
需要保证在这种情况下 `VPC` 能够正确的指向受害指令，同时保证延迟槽标记正确

所以对于 Stall 产生的 `NOP` 而言，需要继承来自阻塞指令的 `PC` 和 `BD`，以保证受害指令信息正确

